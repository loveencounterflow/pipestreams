// Generated by CoffeeScript 2.3.1
(function() {
  //###########################################################################################################
  var $, $async, CND, PS, after, alert, async_with_end_detection, async_with_end_detection_2, async_with_first_and_last, badge, debug, defer, demo_merge_1, demo_merge_async_sources, demo_mux_async_sources_1, demo_mux_async_sources_2, demo_through, duplex_stream_3, duplex_stream_4, echo, help, info, is_empty, jr, log, new_async_source, pull_pair_1, pull_pair_2, rpr, sync_with_first_and_last, urge, warn, whisper, wye_1, wye_2;

  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'PIPESTREAMS/EXPERIMENTS/VARIOUS-PULL-STREAMS';

  log = CND.get_logger('plain', badge);

  info = CND.get_logger('info', badge);

  whisper = CND.get_logger('whisper', badge);

  alert = CND.get_logger('alert', badge);

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  help = CND.get_logger('help', badge);

  urge = CND.get_logger('urge', badge);

  echo = CND.echo.bind(CND);

  //...........................................................................................................
  PS = require('../..');

  ({$, $async} = PS);

  //...........................................................................................................
  after = function(dts, f) {
    return setTimeout(f, dts * 1000);
  };

  defer = setImmediate;

  ({jr, is_empty} = CND);

  // https://pull-stream.github.io/#pull-through
  // nope https://github.com/dominictarr/pull-flow (https://github.com/pull-stream/pull-stream/issues/4)

  // https://github.com/pull-stream/pull-cont
  // https://github.com/pull-stream/pull-defer
  // https://github.com/scrapjs/pull-imux

  //-----------------------------------------------------------------------------------------------------------
  demo_merge_1 = function() {
    /* https://github.com/pull-stream/pull-merge */
    var merge, pipeline, pull;
    pull = require('pull-stream');
    merge = require('pull-merge');
    pipeline = [];
    // pipeline.push merge ( pull.values [ 1, 5, 6, ] ), ( pull.values [ 2, 4, 7, ] )
    // pipeline.push merge ( pull.values [ 1, 5, 6, ] ), ( pull.values [ 2, 4, 7, 10, 11, 12, ] )
    // pipeline.push merge ( pull.values [ 1, 5, 6, ] ), ( pull.values [] )
    // pipeline.push merge ( pull.values [ 1, 5, 6, ] ), ( pull.values [ 1, 5, 6, ] )
    // pipeline.push merge ( pull.values [ [1], [5], [6], ] ), ( pull.values [ [1], [5], [6], [7], ] )
    pipeline.push(merge(pull.values([1, 5, 6]), pull.values([1, 5, 6]), function(a, b) {
      return -1;
    }));
    pipeline.push(pull.collect(function(error, collector) {
      if (error != null) {
        throw error;
      }
      return help(collector);
    }));
    pull(...pipeline);
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  new_async_source = function(name) {
    var R, pipeline, source;
    source = PS.new_push_source();
    pipeline = [];
    pipeline.push(source);
    pipeline.push(PS.$watch(function(d) {
      return urge(name, jr(d));
    }));
    R = PS.pull(...pipeline);
    R.push = function(x) {
      return source.push(x);
    };
    R.end = function() {
      return source.end();
    };
    return R;
  };

  //-----------------------------------------------------------------------------------------------------------
  demo_merge_async_sources = function() {
    /* won't take all inputs from both sources */
    var merge, source_1, source_2;
    merge = require('pull-merge');
    source_1 = new_async_source('s1');
    source_2 = new_async_source('s2');
    return new Promise(function(resolve) {
      var pipeline;
      pipeline = [];
      pipeline.push(merge(source_2, source_1, function(a, b) {
        return -1;
      }));
      pipeline.push(PS.$watch(function(d) {
        return help('-->', jr(d));
      }));
      pipeline.push(PS.$drain(function() {
        help('ok');
        return resolve(null);
      }));
      PS.pull(...pipeline);
      after(0.1, function() {
        return source_2.push(4);
      });
      after(0.2, function() {
        return source_2.push(5);
      });
      after(0.3, function() {
        return source_2.push(6);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.5, function() {
        return source_1.push(2);
      });
      after(0.6, function() {
        return source_1.push(3);
      });
      // after 1.0, -> source_1.push null
      // after 1.0, -> source_2.push null
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  demo_mux_async_sources_1 = function() {
    var $_demux, $_mux, mux;
    mux = require('pull-mux');
    //.........................................................................................................
    /* https://github.com/nichoth/pull-mux */    $_mux = function(...sources) {
      var R, i, idx, len, source;
      R = {};
      for (idx = i = 0, len = sources.length; i < len; idx = ++i) {
        source = sources[idx];
        R[idx] = source;
      }
      return mux(R);
    };
    //.........................................................................................................
    $_demux = function() {
      return PS.$map(function([k, v]) {
        return v;
      });
    };
    //.........................................................................................................
    return new Promise(function(resolve) {
      var pipeline, source_1, source_2;
      pipeline = [];
      source_1 = new_async_source('s1');
      source_2 = new_async_source('s2');
      pipeline.push($_mux(source_1, source_2));
      pipeline.push($_demux());
      pipeline.push(PS.$collect());
      pipeline.push(PS.$watch(function(d) {
        return help('-->', jr(d));
      }));
      pipeline.push(PS.$drain(function() {
        help('ok');
        return resolve(null);
      }));
      PS.pull(...pipeline);
      after(0.1, function() {
        return source_2.push(4);
      });
      after(0.5, function() {
        return source_1.push(2);
      });
      after(0.6, function() {
        return source_1.push(3);
      });
      after(0.2, function() {
        return source_2.push(5);
      });
      after(0.3, function() {
        return source_2.push(6);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.05, function() {
        return source_2.push(42);
      });
      after(1.0, function() {
        return source_1.end();
      });
      after(1.0, function() {
        return source_2.end();
      });
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  demo_mux_async_sources_2 = function() {
    var mux;
    mux = require('pull-mux');
    //-----------------------------------------------------------------------------------------------------------
    /* https://github.com/nichoth/pull-mux */    PS.$wye = function(...sources) {
      var $_demux, $_mux, pipeline;
      //.........................................................................................................
      $_mux = function(...sources) {
        var R, i, idx, len, source;
        R = {};
        for (idx = i = 0, len = sources.length; i < len; idx = ++i) {
          source = sources[idx];
          R[idx] = source;
        }
        return mux(R);
      };
      //.........................................................................................................
      $_demux = function() {
        return PS.$map(function([k, v]) {
          return v;
        });
      };
      //.........................................................................................................
      pipeline = [];
      pipeline.push($_mux(...sources));
      pipeline.push($_demux());
      return PS.pull(...pipeline);
    };
    //.........................................................................................................
    return new Promise(function(resolve) {
      var pipeline, source_1, source_2;
      pipeline = [];
      source_1 = new_async_source('s1');
      source_2 = new_async_source('s2');
      pipeline.push(PS.$wye(source_1, source_2));
      pipeline.push(PS.$collect());
      pipeline.push(PS.$watch(function(d) {
        return help('-->', jr(d));
      }));
      pipeline.push(PS.$drain(function() {
        help('ok');
        return resolve(null);
      }));
      PS.pull(...pipeline);
      after(0.1, function() {
        return source_2.push(4);
      });
      after(0.5, function() {
        return source_1.push(2);
      });
      after(0.6, function() {
        return source_1.push(3);
      });
      after(0.2, function() {
        return source_2.push(5);
      });
      after(0.3, function() {
        return source_2.push(6);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.4, function() {
        return source_1.push(1);
      });
      after(0.05, function() {
        return source_2.push(42);
      });
      after(1.0, function() {
        return source_1.end();
      });
      after(1.0, function() {
        return source_2.end();
      });
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  demo_through = function() {
    var through;
    return through = require('pull-through');
  };

  //-----------------------------------------------------------------------------------------------------------
  /* https://github.com/pull-stream/pull-through */  async_with_end_detection = function() {
    var buffer, flush, pipeline, send;
    buffer = [11, 12, 13, 14, 15];
    pipeline = [];
    send = null;
    flush = () => {
      var results;
      results = [];
      while (!is_empty(buffer)) {
        results.push(send(buffer.pop()));
      }
      return results;
    };
    pipeline.push(PS.new_value_source([1, 2, 3, 4, 5]));
    pipeline.push(PS.$defer());
    //.........................................................................................................
    pipeline.push((() => {
      var is_first;
      is_first = true;
      return $({
        last: PS.symbols.last
      }, (d, send) => {
        if (is_first) {
          is_first = false;
          send(PS.symbols.first);
        }
        return send(d);
      });
    })());
    //.........................................................................................................
    pipeline.push(PS.$async((d, _send, done) => {
      send = _send;
      switch (d) {
        case PS.symbols.first:
          debug('start');
          send(buffer.pop());
          done();
          break;
        case PS.symbols.last:
          flush();
          debug('end');
          // done()
          after(2, done);
          break;
        default:
          send(d);
          done();
      }
      return null;
    }));
    //.........................................................................................................
    pipeline.push(PS.$show());
    pipeline.push(PS.$drain());
    PS.pull(...pipeline);
    //.........................................................................................................
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  async_with_end_detection_2 = function() {
    var buffer, flush, pipeline, send;
    buffer = [11, 12, 13, 14, 15];
    pipeline = [];
    send = null;
    flush = () => {
      var results;
      results = [];
      while (!is_empty(buffer)) {
        results.push(send(buffer.pop()));
      }
      return results;
    };
    //.........................................................................................................
    pipeline.push(PS.new_value_source([1, 2, 3, 4, 5]));
    pipeline.push(PS.$defer());
    //.........................................................................................................
    pipeline.push(PS.$async('null', (d, _send, done) => {
      send = _send;
      if (d != null) {
        send(d);
        done();
      } else {
        flush();
        debug('end');
        // done()
        after(2, done);
      }
      return null;
    }));
    //.........................................................................................................
    pipeline.push(PS.$show());
    pipeline.push(PS.$drain());
    PS.pull(...pipeline);
    //.........................................................................................................
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  sync_with_first_and_last = function() {
    var drainer, pipeline;
    drainer = function() {
      return help('ok');
    };
    pipeline = [];
    pipeline.push(PS.new_value_source([1, 2, 3, 4, 5]));
    //.........................................................................................................
    pipeline.push(PS.$surround({
      first: '[',
      last: ']',
      before: '(',
      between: ',',
      after: ')'
    }));
    pipeline.push(PS.$surround({
      first: 'first',
      last: 'last'
    }));
    // pipeline.push PS.$surround { first: 'first', last: 'last', before: 'before', between: 'between', after: 'after' }
    // pipeline.push PS.$surround { first: '[', last: ']', }
    //.........................................................................................................
    pipeline.push(PS.$collect());
    pipeline.push($(function(d, send) {
      var x;
      return send(((function() {
        var i, len, results;
        results = [];
        for (i = 0, len = d.length; i < len; i++) {
          x = d[i];
          results.push(x.toString());
        }
        return results;
      })()).join(''));
    }));
    pipeline.push(PS.$show());
    pipeline.push(PS.$drain(drainer));
    PS.pull(...pipeline);
    //.........................................................................................................
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  async_with_first_and_last = function() {
    var drainer, pipeline;
    drainer = function() {
      return help('ok');
    };
    pipeline = [];
    pipeline.push(PS.new_value_source([1, 2, 3]));
    //.........................................................................................................
    pipeline.push(PS.$surround({
      first: 'first',
      last: 'last'
    }));
    pipeline.push($async({
      first: '[',
      last: ']',
      between: '|'
    }, (d, send, done) => {
      return defer(function() {
        // debug '22922', jr d
        send(d);
        return done();
      });
    }));
    //.........................................................................................................
    // pipeline.push PS.$watch ( d ) -> urge '20292', d
    pipeline.push(PS.$collect());
    pipeline.push($(function(d, send) {
      var x;
      return send(((function() {
        var i, len, results;
        results = [];
        for (i = 0, len = d.length; i < len; i++) {
          x = d[i];
          results.push(x.toString());
        }
        return results;
      })()).join(''));
    }));
    pipeline.push(PS.$show());
    pipeline.push(PS.$drain(drainer));
    PS.pull(...pipeline);
    //.........................................................................................................
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  pull_pair_1 = function() {
    var new_pair, pair, pipeline_1, pipeline_2;
    new_pair = require('pull-pair');
    pair = new_pair();
    pipeline_1 = [];
    pipeline_2 = [];
    //.........................................................................................................
    // read values into this sink...
    pipeline_1.push(PS.new_value_source([1, 2, 3]));
    pipeline_1.push(PS.$watch(function(d) {
      return urge(d);
    }));
    pipeline_1.push(pair.sink);
    PS.pull(...pipeline_1);
    //.........................................................................................................
    // but that should become the source over here.
    pipeline_2.push(pair.source);
    pipeline_2.push(PS.$collect());
    pipeline_2.push(PS.$show());
    pipeline_2.push(PS.$drain());
    //.........................................................................................................
    PS.pull(...pipeline_2);
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  pull_pair_2 = function() {
    var f, new_pair, pipeline;
    new_pair = require('pull-pair');
    //.........................................................................................................
    f = function() {
      var pair, pipeline_1, pushable;
      pair = new_pair();
      pushable = PS.new_push_source();
      pipeline_1 = [];
      //.......................................................................................................
      pipeline_1.push(pair.source);
      pipeline_1.push(PS.$surround({
        before: '(',
        after: ')',
        between: '-'
      }));
      pipeline_1.push(PS.$join());
      pipeline_1.push(PS.$show({
        title: 'substream'
      }));
      pipeline_1.push(PS.$watch(function(d) {
        return pushable.push(d);
      }));
      pipeline_1.push(PS.$drain());
      //.......................................................................................................
      PS.pull(...pipeline_1);
      return {
        sink: pair.sink,
        source: pushable
      };
    };
    //.........................................................................................................
    pipeline = [];
    pipeline.push(PS.new_value_source("just a few words".split(/\s/)));
    pipeline.push(PS.$watch(function(d) {
      return whisper(d);
    }));
    pipeline.push(f());
    pipeline.push(PS.$show({
      title: 'mainstream'
    }));
    pipeline.push(PS.$drain());
    PS.pull(...pipeline);
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  wye_1 = function() {
    var $wye, bysource, new_pair, pipeline;
    new_pair = require('pull-pair');
    //.........................................................................................................
    $wye = function(bystream) {
      var confluence, pair, pipeline_1, pipeline_2, pushable;
      pair = new_pair();
      pushable = PS.new_push_source();
      pipeline_1 = [];
      pipeline_2 = [];
      //.......................................................................................................
      pipeline_1.push(pair.source);
      pipeline_1.push(PS.$surround({
        before: '(',
        after: ')',
        between: '-'
      }));
      // pipeline_1.push PS.$join()
      pipeline_1.push(PS.$show({
        title: 'substream'
      }));
      pipeline_1.push(PS.$watch(function(d) {
        return pushable.push(d);
      }));
      pipeline_1.push(PS.$drain(function() {
        return urge("substream ended");
      }));
      //.......................................................................................................
      pipeline_2.push(bystream);
      pipeline_2.push($({
        last: null
      }, function(d, send) {
        if (d == null) {
          urge("bystream ended");
        }
        return send(d);
      }));
      pipeline_2.push(PS.$show({
        title: 'bystream'
      }));
      //.......................................................................................................
      PS.pull(...pipeline_1);
      confluence = PS.$merge(pushable, PS.pull(...pipeline_2));
      return {
        sink: pair.sink,
        source: confluence
      };
    };
    //.........................................................................................................
    bysource = PS.new_value_source([3, 4, 5, 6, 7]);
    pipeline = [];
    pipeline.push(PS.new_value_source("just a few words".split(/\s/)));
    // pipeline.push PS.$watch ( d ) -> whisper d
    pipeline.push($wye(bysource));
    pipeline.push(PS.$collect());
    pipeline.push(PS.$show({
      title: 'mainstream'
    }));
    pipeline.push(PS.$drain(function() {
      return help('ok');
    }));
    PS.pull(...pipeline);
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  wye_2 = async function() {
    var $wye, demo, new_pair;
    new_pair = require('pull-pair');
    //.........................................................................................................
    $wye = function(bystream) {
      var byline, bystream_ended, confluence, end_sym, pair, pushable, subline, substream_ended;
      pair = new_pair();
      pushable = PS.new_push_source();
      subline = [];
      byline = [];
      end_sym = Symbol('end');
      bystream_ended = false;
      substream_ended = false;
      //.......................................................................................................
      subline.push(pair.source);
      subline.push($({
        last: end_sym
      }, function(d, send) {
        if (d === end_sym) {
          substream_ended = true;
          if (bystream_ended) {
            return pushable.end();
          }
        } else {
          return pushable.push(d);
        }
      }));
      subline.push(PS.$drain());
      //.......................................................................................................
      byline.push(bystream);
      byline.push($({
        last: end_sym
      }, function(d, send) {
        if (d === end_sym) {
          bystream_ended = true;
          if (substream_ended) {
            return pushable.end();
          }
        } else {
          return send(d);
        }
      }));
      //.......................................................................................................
      PS.pull(...subline);
      confluence = PS.$merge(pushable, PS.pull(...byline));
      return {
        sink: pair.sink,
        source: confluence
      };
    };
    //.........................................................................................................
    demo = function() {
      return new Promise(function(resolve) {
        var byline, mainline;
        byline = [];
        byline.push(PS.new_value_source([3, 4, 5, 6, 7]));
        byline.push(PS.$watch(function(d) {
          return whisper('bystream', jr(d));
        }));
        //.......................................................................................................
        mainline = [];
        mainline.push(PS.new_value_source("just a few words".split(/\s/)));
        mainline.push(PS.$watch(function(d) {
          return whisper('mainstream', jr(d));
        }));
        mainline.push($wye(PS.pull(...byline)));
        mainline.push(PS.$collect());
        mainline.push(PS.$show({
          title: 'mainstream'
        }));
        mainline.push(PS.$drain(function() {
          help('ok');
          return resolve();
        }));
        return PS.pull(...mainline);
      });
    };
    await demo();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  duplex_stream_3 = function() {
    var client, new_duplex_pair, pipeline_1, pipeline_2, server;
    new_duplex_pair = require('pull-pair/duplex');
    [client, server] = new_duplex_pair();
    pipeline_1 = [];
    pipeline_2 = [];
    //.........................................................................................................
    pipeline_1.push(PS.new_value_source([1, 2, 3]));
    pipeline_1.push(client);
    pipeline_1.push(PS.$collect());
    pipeline_1.push(PS.$show());
    // pipeline_1.push client
    pipeline_1.push(PS.$drain());
    PS.pull(...pipeline_1);
    //.........................................................................................................
    // pipe the second duplex stream back to itself.
    pipeline_2.push(server);
    pipeline_2.push(PS.$watch(function(d) {
      return urge(d);
    }));
    pipeline_2.push($(function(d, send) {
      return send(d * 10);
    }));
    pipeline_2.push(server);
    PS.pull(...pipeline_2);
    //.........................................................................................................
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  duplex_stream_4 = function() {
    var client, new_duplex_pair, pipeline_1, pipeline_2, server;
    new_duplex_pair = require('pull-pair/duplex');
    [client, server] = new_duplex_pair();
    pipeline_1 = [];
    pipeline_2 = [];
    //.........................................................................................................
    pipeline_1.push(PS.new_value_source([1, 2, 3]));
    pipeline_1.push(client);
    pipeline_1.push(PS.$collect());
    pipeline_1.push(PS.$show());
    // pipeline_1.push client
    pipeline_1.push(PS.$drain());
    PS.pull(...pipeline_1);
    //.........................................................................................................
    // pipe the second duplex stream back to itself.
    pipeline_2.push(server);
    pipeline_2.push(PS.$watch(function(d) {
      return urge(d);
    }));
    pipeline_2.push($(function(d, send) {
      return send(d * 10);
    }));
    pipeline_2.push(server);
    pipeline_1.push(PS.$drain());
    PS.pull(...pipeline_2);
    //.........................................................................................................
    return null;
  };

  //###########################################################################################################
  if (module.parent == null) {
    // demo_merge_1()
    // demo_merge_async_sources()
    // demo_mux_async_sources_1()
    // demo_mux_async_sources_2()
    // demo_through()
    // async_with_end_detection()
    // async_with_end_detection_2()
    // sync_with_first_and_last()
    // async_with_first_and_last()
    // pull_pair_1()
    // pull_pair_2()
    // wye_1()
    wye_2();
  }

  // duplex_stream_3()
// duplex_stream_4()

}).call(this);

//# sourceMappingURL=various-pull-streams.js.map
