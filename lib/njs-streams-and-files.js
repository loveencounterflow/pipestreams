// Generated by CoffeeScript 2.3.2
(function() {
  'use strict';
  var CND, FS, STPS, badge;

  //###########################################################################################################
  CND = require('cnd');

  badge = 'PIPESTREAMS/NJS-STREAMS-AND-FILES';

  FS = require('fs');

  STPS = require('stream-to-pull-stream');

  //===========================================================================================================
  // READ FROM, WRITE TO FILES, NODEJS STREAMS
  //-----------------------------------------------------------------------------------------------------------
  this.read_from_file = function(path, options) {
    /* TAINT consider using https://pull-stream.github.io/#pull-file-reader instead */
    var arity, on_stop;
    switch ((arity = arguments.length)) {
      case 1:
        null;
        break;
      case 2:
        if (CND.isa_function(options)) {
          [path, options, on_stop] = [path, null, options];
        }
        break;
      default:
        throw new Error(`µ9983 expected 1 or 2 arguments, got ${arity}`);
    }
    //.........................................................................................................
    return this.read_from_nodejs_stream(FS.createReadStream(path, options));
  };

  //-----------------------------------------------------------------------------------------------------------
  this.read_chunks_from_file = function(path, byte_count) {
    var pfy, source;
    if (!((CND.isa_number(byte_count)) && (byte_count > 0) && (byte_count === parseInt(byte_count)))) {
      throw new Error(`expected positive integer number, got ${rpr(byte_count)}`);
    }
    pfy = (require('util')).promisify;
    source = this.new_push_source();
    //.........................................................................................................
    defer(async() => {
      var buffer, fd, read;
      fd = (await (pfy(FS.open))(path, 'r'));
      read = pfy(FS.read);
      while (true) {
        buffer = Buffer.alloc(byte_count);
        await read(fd, buffer, 0, byte_count, null);
        source.send(buffer);
      }
      return null;
    });
    //.........................................................................................................
    return source;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.write_to_file = function(path, options, on_stop) {
    /* TAINT consider using https://pull-stream.github.io/#pull-write-file instead */
    /* TAINT code duplication */
    var arity;
    switch ((arity = arguments.length)) {
      case 1:
        null;
        break;
      case 2:
        if (CND.isa_function(options)) {
          [path, options, on_stop] = [path, null, options];
        }
        break;
      case 3:
        break;
      default:
        throw new Error(`µ9983 expected 1 to 3 arguments, got ${arity}`);
    }
    //.........................................................................................................
    return this.write_to_nodejs_stream(FS.createWriteStream(path, options), on_stop);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.read_from_nodejs_stream = function(stream) {
    var arity;
    switch ((arity = arguments.length)) {
      case 1:
        null;
        break;
      default:
        throw new Error(`µ9983 expected 1 argument, got ${arity}`);
    }
    //.........................................................................................................
    return STPS.source(stream, function(error) {
      return finish(error);
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.write_to_nodejs_stream = function(stream, on_stop) {
    /* TAINT code duplication */
    var arity, finish, has_finished, type;
    switch ((arity = arguments.length)) {
      case 1:
      case 2:
        null;
        break;
      default:
        throw new Error(`µ9983 expected 1 or 2 arguments, got ${arity}`);
    }
    //.........................................................................................................
    if ((on_stop != null) && ((type = CND.type_of(on_stop)) !== 'function')) {
      throw new Error(`µ9383 expected a function, got a ${type}`);
    }
    //.........................................................................................................
    has_finished = false;
    //.........................................................................................................
    finish = function(error) {
      /* In case there was an error, throw that error if we already called on_stop, or there is no
      callback given; this is to prevent silent failures: */
      if ((error != null) && (has_finished || (on_stop == null))) {
        has_finished = true;
        throw error;
      }
      //.......................................................................................................
      /* Otherwise, call back (with optional error) only in case we have not yet finished; this is to
      prevent inadvertently calling back more than once: */
      if (!has_finished) {
        has_finished = true;
        if (on_stop != null) {
          if (error != null) {
            return on_stop(error);
          }
          return on_stop();
        }
      }
      //.......................................................................................................
      return null;
    };
    //.........................................................................................................
    stream.on('close', function() {
      return finish();
    });
    return STPS.sink(stream, function(error) {
      return finish(error);
    });
  };

}).call(this);

//# sourceMappingURL=njs-streams-and-files.js.map
