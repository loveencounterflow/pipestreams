// Generated by CoffeeScript 2.3.1
(function() {
  'use strict';
  var CND, badge, debug, defer/* https://github.com/nichoth/pull-mux */, jr, mux, rpr;

  //###########################################################################################################
  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'PIPESTREAMS/WYE-TEE-MERGE';

  // log                       = CND.get_logger 'plain',     badge
  // info                      = CND.get_logger 'info',      badge
  // whisper                   = CND.get_logger 'whisper',   badge
  // alert                     = CND.get_logger 'alert',     badge
  debug = CND.get_logger('debug', badge);

  // warn                      = CND.get_logger 'warn',      badge
  // help                      = CND.get_logger 'help',      badge
  // urge                      = CND.get_logger 'urge',      badge
  // echo                      = CND.echo.bind CND
  ({jr} = CND);

  mux = require('pull-mux');

  defer = setImmediate;

  //-----------------------------------------------------------------------------------------------------------
  this.$tee = function(stream) {
    /* **NB** that in contradistinction to `pull-tee`, you can only divert to a single by-stream with each
    call to `PS.$tee` */
    // R = if ( CND.isa_list stream_or_pipeline ) then ( pull stream_or_pipeline ) else stream_or_pipeline
    return (require('pull-tee'))(stream);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$merge = function(...sources) {
    var $_demux, $_mux, pipeline;
    //.........................................................................................................
    $_mux = (...sources) => {
      var R, i, idx, len, source;
      R = {};
      for (idx = i = 0, len = sources.length; i < len; idx = ++i) {
        source = sources[idx];
        R[idx] = source;
      }
      return mux(R);
    };
    //.........................................................................................................
    $_demux = () => {
      return this.$map(function([k, v]) {
        return v;
      });
    };
    //.........................................................................................................
    pipeline = [];
    pipeline.push($_mux(...sources));
    pipeline.push($_demux());
    return this.pull(...pipeline);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$wye = function(bystream) {
    var byline, bystream_ended, confluence, end_sym, pair, pushable, subline, substream_ended;
    pair = (require('pull-pair'))();
    pushable = this.new_push_source();
    subline = [];
    byline = [];
    end_sym = Symbol('end');
    bystream_ended = false;
    substream_ended = false;
    //.........................................................................................................
    subline.push(pair.source);
    subline.push(this.$({
      last: end_sym
    }, function(d, send) {
      if (d === end_sym) {
        substream_ended = true;
        if (bystream_ended) {
          return pushable.end();
        }
      } else {
        return pushable.send(d);
      }
    }));
    subline.push(this.$drain());
    //.........................................................................................................
    byline.push(bystream);
    byline.push(this.$({
      last: end_sym
    }, function(d, send) {
      if (d === end_sym) {
        bystream_ended = true;
        if (substream_ended) {
          return pushable.end();
        }
      } else {
        return send(d);
      }
    }));
    //.........................................................................................................
    this.pull(...subline);
    confluence = this.$merge(pushable, this.pull(...byline));
    return {
      sink: pair.sink,
      source: confluence
    };
  };

}).call(this);

//# sourceMappingURL=wye-tee-merge.js.map
